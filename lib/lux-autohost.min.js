/**
 * lux-autohost - Action Creator API for submitting logging & metrics to autohost from lux.js apps.
 * Author: Jim Cowart
 * Version: v0.1.0
 * Url: https://github.com/LeanKit-Labs/lux-autohost
 * License(s): MIT Copyright (c) 2015 LeanKit
 */
(function(t,n){"function"==typeof define&&define.amd?define(["lux.js","postal","machina","lodash","moment"],n):"object"==typeof module&&module.exports?module.exports=n(require("lux.js"),require("postal"),require("machina"),require("lodash"),require("moment")):t.luxah=n(t.lux,t.postal,t.machina,t._,t.moment)})(this,function(t,n,e,i,o){function r(t){return t&&i.merge(d,t),d}function a(t,n){var e=n;return window&&window.location&&window.navigator&&(e={data:n,location:window.location.href,userAgent:window.navigator.userAgent}),{msg:e,timestamp:o.utc().toISOString(),type:t,level:m.indexOf(t)+1}}function c(n,e){t.publishAction("sendLogEntry",a(n,e))}function s(t,n,e,i,r){return{type:t,key:n,timestamp:o.utc().toISOString(),value:e,units:i}}function u(t){return-1===v.indexOf(t)&&(!d.filter.include&&-1===d.filter.actions.indexOf(t)||d.filter.include&&d.filter.actions.indexOf(t)>-1)}function l(){var n,e,i=Array.from(arguments);return t.getContextKey?t.getContextKey.apply(t,arguments):(n=window.location.host.replace(/\./gi,"-"),e=window.location.pathname.replace(/\//gi,"-"),e="-"===e[0]?e.slice(1):e,[n,e].concat(i).join("."))}var d={actionChannel:n.channel("lux.action"),filter:{include:!1,actions:[]},metrics:{timeout:3e4,messages:500},logging:{timeout:5e3,messages:25}};t.customActionCreator({sendLogBatch:function(){var t=Array.from(arguments);d.actionChannel.publish({topic:"execute.sendLogBatch",data:{actionType:"sendLogBatch",actionArgs:t}})},sendMetricsBatch:function(){var t=Array.from(arguments);d.actionChannel.publish({topic:"execute.sendMetricsBatch",data:{actionType:"sendMetricsBatch",actionArgs:t}})}});var m=["error","warn","info","debug"],h=i.reduce(m,function(t,n){return t[n]=function(t){return c(n,t)},t},{});t.customActionCreator(h),t.addToActionGroup("logging",m);var f={meter:function(n,e,i,o){t.publishAction("sendMetricsEntry",s("meter",n,e,i,o))},timer:function(n,e,i){t.publishAction("sendMetricsEntry",s("timer",n,e,"ms",i))}};t.customActionCreator(f),t.addToActionGroup("metrics",["meter","timer"]);var g={action:"sendMetricsBatch",queue:[],config:d.metrics},p={action:"sendLogBatch",queue:[],config:d.logging},y=new e.BehavioralFsm({initialState:"queueing",states:{queueing:{_onEnter:function(t){var n=this;t.timeout=setTimeout(function(){return n.handle(t,"transmit")},t.config.timeout)},queueEntry:function(t,n){t.queue.push(n),t.queue.length>=t.config.messages&&this.transition(t,"transmitting")},transmit:"transmitting"},transmitting:{_onEnter:function(t){clearTimeout(t.timeout),this.handle(t,"transmit")},transmit:function(n){if(n.queue.length){var e=n.queue;n.queue=[],t.publishAction(n.action,e)}this.transition(n,"queueing")}}}}),q=t.actionListener({handlers:{sendLogEntry:function(t){y.handle(p,"queueEntry",t)},sendMetricsEntry:function(t){y.handle(g,"queueEntry",t)}}}),v=["sendLogEntry","sendMetricsEntry","sendLogBatch","sendMetricsBatch"],w=new e.Fsm({initialize:function(){var n=this;t.dispatcher.on("handling",function(t){"action.dispatch"===t.inputType&&n.handle("start",t.client.action.actionType)}),t.dispatcher.on("transition",function(t){"ready"===t.toState&&n.handle("dispatcher.complete")})},initialState:"ready",states:{ready:{_onEnter:function(){this.current={}},start:function(t){var n=this;u(t)&&(this.current={name:t,start:o.utc(),key:l(t)},setTimeout(function(){return n.handle("action.complete")},0),this.transition("processing"))}},processing:{_onEnter:function(){f.meter(this.current.key,1,"count",{})},"action.complete":"ready","*":function(){this.deferUntilTransition()},_onExit:function(){f.timer(this.current.key,o.utc().diff(this.current.start),{})}}}});return{config:r,actionProcessor:w,batchManager:y,batchListener:q,metricsClient:g,loggingClient:p}});