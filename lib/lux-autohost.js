/**
 * lux-autohost - Action Creator API for submitting logging & metrics to autohost from lux.js apps.
 * Author: Jim Cowart
 * Version: v0.1.0
 * Url: https://github.com/LeanKit-Labs/lux-autohost
 * License(s): MIT Copyright (c) 2015 LeanKit
 */

( function( root, factory ) {
	/* istanbul ignore next - don't test UMD wrapper */
	if ( typeof define === "function" && define.amd ) {
		// AMD. Register as an anonymous module.
		define( [ "lux.js", "postal", "machina", "lodash", "moment" ], factory );
	} else if ( typeof module === "object" && module.exports ) {
		// Node, or CommonJS-Like environments
		module.exports = factory( require( "lux.js" ), require( "postal" ), require( "machina" ), require( "lodash" ), require( "moment" ) );
	} else {
		root.luxah = factory( root.lux, root.postal, root.machina, root._, root.moment );
	}
} )( this, function( lux, postal, machina, _, moment ) {
	var configuration = {
		actionChannel: postal.channel( "lux.action" ),
		filter: {
			include: false,
			actions: []
		},
		metrics: {
			timeout: 30000,
			messages: 500
		},
		logging: {
			timeout: 5000,
			messages: 25
		}
	};

	function config( options ) {
		if ( options ) {
			_.merge( configuration, options );
		}
		return configuration;
	}

	lux.customActionCreator( {
		sendLogBatch: function sendLogBatch() {
			var args = Array.from( arguments );
			configuration.actionChannel.publish( {
				topic: "execute.sendLogBatch",
				data: {
					actionType: "sendLogBatch",
					actionArgs: args
				}
			} );
		},
		sendMetricsBatch: function sendMetricsBatch() {
			var args = Array.from( arguments );
			configuration.actionChannel.publish( {
				topic: "execute.sendMetricsBatch",
				data: {
					actionType: "sendMetricsBatch",
					actionArgs: args
				}
			} );
		}
	} );

	var logLevels = [ "error", "warn", "info", "debug" ];

	function formatLogEntry( type, data ) {
		var msg = data;

		if ( window && window.location && window.navigator ) {
			msg = {
				data: data,
				location: window.location.href,
				userAgent: window.navigator.userAgent
			};
		}

		return {
			msg: msg,
			timestamp: moment.utc().toISOString(),
			type: type,
			level: logLevels.indexOf( type ) + 1
		};
	}

	function logIt( type, data ) {
		lux.publishAction( "sendLogEntry", formatLogEntry( type, data ) );
	}

	var loggingApi = _.reduce( logLevels, function( acc, level ) {
		acc[level] = function( data ) {
			return logIt( level, data );
		};
		return acc;
	}, {} );

	lux.customActionCreator( loggingApi );

	lux.addToActionGroup( "logging", logLevels );

	// Need to figure out about custom metadata
	function formatMetricsEntry( type, key, value, unit, data ) {
		return {
			type: type, // "time" | "meter" | [custom value]
			key: key, // your metric key
			timestamp: moment.utc().toISOString(),
			value: value,
			units: unit
		};
	}

	var metricsApi = {
		meter: function meter( key, value, unit, customData ) {
			lux.publishAction( "sendMetricsEntry", formatMetricsEntry( "meter", key, value, unit, customData ) );
		},
		timer: function timer( key, value, customData ) {
			lux.publishAction( "sendMetricsEntry", formatMetricsEntry( "timer", key, value, "ms", customData ) );
		}
	};

	lux.customActionCreator( metricsApi );

	lux.addToActionGroup( "metrics", [ "meter", "timer" ] );

	var metricsClient = {
		action: "sendMetricsBatch",
		queue: [],
		config: configuration.metrics
	};
	var loggingClient = {
		action: "sendLogBatch",
		queue: [],
		config: configuration.logging
	};

	var batchManager = new machina.BehavioralFsm( {
		initialState: "queueing",
		states: {
			// Might need an initializing state
			queueing: {
				_onEnter: function _onEnter( client ) {
					// istanbul ignore next

					var _this = this;

					client.timeout = setTimeout( function() {
						return _this.handle( client, "transmit" );
					}, client.config.timeout );
				},
				queueEntry: function queueEntry( client, data ) {
					client.queue.push( data );
					if ( client.queue.length >= client.config.messages ) {
						this.transition( client, "transmitting" );
					}
				},
				transmit: "transmitting"
			},
			transmitting: {
				_onEnter: function _onEnter( client ) {
					clearTimeout( client.timeout );
					this.handle( client, "transmit" );
				},
				transmit: function transmit( client ) {
					if ( client.queue.length ) {
						var queue = client.queue;
						client.queue = [];
						lux.publishAction( client.action, queue );
					}
					this.transition( client, "queueing" );
				}
			}
		}
	} );

	var batchListener = lux.actionListener( {
		handlers: {
			sendLogEntry: function sendLogEntry( data ) {
				batchManager.handle( loggingClient, "queueEntry", data );
			},
			sendMetricsEntry: function sendMetricsEntry( data ) {
				batchManager.handle( metricsClient, "queueEntry", data );
			}
		}
	} );

	var ignoredActions = [ "sendLogEntry", "sendMetricsEntry", "sendLogBatch", "sendMetricsBatch" ];

	function isMonitored( action ) {
		return ignoredActions.indexOf( action ) === -1 && ( !configuration.filter.include && configuration.filter.actions.indexOf( action ) === -1 || configuration.filter.include && configuration.filter.actions.indexOf( action ) > -1 );
	}

	function getContextKey() {
		var args = Array.from( arguments );
		var host;
		var path;
		if ( lux.getContextKey ) {
			return lux.getContextKey.apply( lux, arguments );
		} else {
			host = window.location.host.replace( /\./gi, "-" );
			path = window.location.pathname.replace( /\//ig, "-" );
			path = path[0] === "-" ? path.slice( 1 ) : path;
			return [ host, path ].concat( args ).join( "." );
		}
	}

	var actionProcessor = new machina.Fsm( {
		initialize: function initialize() {
			// istanbul ignore next

			var _this2 = this;

			lux.dispatcher.on( "handling", function( data ) {
				if ( data.inputType === "action.dispatch" ) {
					_this2.handle( "start", data.client.action.actionType );
				}
			} );
			lux.dispatcher.on( "transition", function( data ) {
				if ( data.toState === "ready" ) {
					_this2.handle( "dispatcher.complete" );
				}
			} );
		},
		initialState: "ready",
		states: {
			ready: {
				_onEnter: function _onEnter() {
					this.current = {};
				},
				start: function start( action ) {
					// istanbul ignore next

					var _this3 = this;

					if ( isMonitored( action ) ) {
						this.current = {
							name: action,
							start: moment.utc(),
							key: getContextKey( action )
						};
						setTimeout( function() {
							return _this3.handle( "action.complete" );
						}, 0 );
						this.transition( "processing" );
					}
				}
			},
			processing: {
				_onEnter: function _onEnter() {
					// ( key, value, unit, customData )
					metricsApi.meter( this.current.key, 1, "count", {} );
				},
				"action.complete": "ready",
				"*": function _() {
					this.deferUntilTransition();
				},
				_onExit: function _onExit() {
					// ( key, value, customData )
					metricsApi.timer( this.current.key, moment.utc().diff( this.current.start ), {} );
				}
			}
		}
	} );

	// jshint ignore: start
	return {
		config: config,
		actionProcessor: actionProcessor,
		batchManager: batchManager,
		batchListener: batchListener,
		metricsClient: metricsClient,
		loggingClient: loggingClient
	};
	// jshint ignore: end
} );
//# sourceMappingURL=data:application/json;base64,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QUc7QUFDNUIsVUFBSSxDQUFDLE9BQU8sR0FBRztBQUNkLFdBQUksRUFBRSxNQUFNO0FBQ1osWUFBSyxFQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUU7QUFDbkIsVUFBRyxFQUFFLGFBQWEsQ0FBRSxNQUFNLENBQUU7T0FDNUIsQ0FBQztBQUNGLGdCQUFVLENBQUU7Y0FBTSxPQUFLLE1BQU0sQ0FBRSxpQkFBaUIsQ0FBRTtPQUFBLEVBQUUsQ0FBQyxDQUFFLENBQUM7QUFDeEQsVUFBSSxDQUFDLFVBQVUsQ0FBRSxZQUFZLENBQUUsQ0FBQztNQUNoQztLQUNEO0lBQ0Q7QUFDRCxhQUFVLEVBQUU7QUFDWCxZQUFRLEVBQUEsb0JBQUc7O0FBRVYsZUFBVSxDQUFDLEtBQUssQ0FBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBRSxDQUFDO0tBQ3JEO0FBQ0QscUJBQWlCLEVBQUUsT0FBTztBQUMxQixPQUFHLEVBQUUsYUFBVztBQUNmLFNBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0tBQzVCO0FBQ0QsV0FBTyxFQUFBLG1CQUFHOztBQUVULGVBQVUsQ0FBQyxLQUFLLENBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBRSxFQUFFLEVBQUUsQ0FBRSxDQUFDO0tBQ2xGO0lBQ0Q7R0FDRDtFQUNELENBQUUsQ0FBQzs7O0FBSUgsUUFBTztBQUNOLFFBQU0sRUFBTixNQUFNO0FBQ04saUJBQWUsRUFBZixlQUFlO0FBQ2YsY0FBWSxFQUFaLFlBQVk7QUFDWixlQUFhLEVBQWIsYUFBYTtBQUNiLGVBQWEsRUFBYixhQUFhO0FBQ2IsZUFBYSxFQUFiLGFBQWE7RUFDYixDQUFDOztDQUVGLENBQUUsQ0FBRyIsImZpbGUiOiJsdXgtYXV0b2hvc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuKCBmdW5jdGlvbiggcm9vdCwgZmFjdG9yeSApIHtcblx0LyogaXN0YW5idWwgaWdub3JlIG5leHQgLSBkb24ndCB0ZXN0IFVNRCB3cmFwcGVyICovXG5cdGlmICggdHlwZW9mIGRlZmluZSA9PT0gXCJmdW5jdGlvblwiICYmIGRlZmluZS5hbWQgKSB7XG5cdFx0Ly8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLlxuXHRcdGRlZmluZSggWyBcImx1eC5qc1wiLCBcInBvc3RhbFwiLCBcIm1hY2hpbmFcIiwgXCJsb2Rhc2hcIiwgXCJtb21lbnRcIiBdLCBmYWN0b3J5ICk7XG5cdH0gZWxzZSBpZiAoIHR5cGVvZiBtb2R1bGUgPT09IFwib2JqZWN0XCIgJiYgbW9kdWxlLmV4cG9ydHMgKSB7XG5cdFx0Ly8gTm9kZSwgb3IgQ29tbW9uSlMtTGlrZSBlbnZpcm9ubWVudHNcblx0XHRtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoIHJlcXVpcmUoIFwibHV4LmpzXCIgKSwgcmVxdWlyZSggXCJwb3N0YWxcIiApLCByZXF1aXJlKCBcIm1hY2hpbmFcIiApLCByZXF1aXJlKCBcImxvZGFzaFwiICksIHJlcXVpcmUoIFwibW9tZW50XCIgKSApO1xuXHR9IGVsc2Uge1xuXHRcdHJvb3QubHV4YWggPSBmYWN0b3J5KCByb290Lmx1eCwgcm9vdC5wb3N0YWwsIHJvb3QubWFjaGluYSwgcm9vdC5fLCByb290Lm1vbWVudCApO1xuXHR9XG59KCB0aGlzLCBmdW5jdGlvbiggbHV4LCBwb3N0YWwsIG1hY2hpbmEsIF8sIG1vbWVudCApIHtcblx0dmFyIGNvbmZpZ3VyYXRpb24gPSB7XG5cdFx0YWN0aW9uQ2hhbm5lbDogcG9zdGFsLmNoYW5uZWwoIFwibHV4LmFjdGlvblwiICksXG5cdFx0ZmlsdGVyOiB7XG5cdFx0XHRpbmNsdWRlOiBmYWxzZSxcblx0XHRcdGFjdGlvbnM6IFtdXG5cdFx0fSxcblx0XHRtZXRyaWNzOiB7XG5cdFx0XHR0aW1lb3V0OiAzMDAwMCxcblx0XHRcdG1lc3NhZ2VzOiA1MDBcblx0XHR9LFxuXHRcdGxvZ2dpbmc6IHtcblx0XHRcdHRpbWVvdXQ6IDUwMDAsXG5cdFx0XHRtZXNzYWdlczogMjVcblx0XHR9XG5cdH07XG5cblx0ZnVuY3Rpb24gY29uZmlnKCBvcHRpb25zICkge1xuXHRcdGlmICggb3B0aW9ucyApIHtcblx0XHRcdF8ubWVyZ2UoIGNvbmZpZ3VyYXRpb24sIG9wdGlvbnMgKTtcblx0XHR9XG5cdFx0cmV0dXJuIGNvbmZpZ3VyYXRpb247XG5cdH1cblxuXHRsdXguY3VzdG9tQWN0aW9uQ3JlYXRvcigge1xuXHRcdHNlbmRMb2dCYXRjaCgpIHtcblx0XHRcdHZhciBhcmdzID0gQXJyYXkuZnJvbSggYXJndW1lbnRzICk7XG5cdFx0XHRjb25maWd1cmF0aW9uLmFjdGlvbkNoYW5uZWwucHVibGlzaCgge1xuXHRcdFx0XHR0b3BpYzogXCJleGVjdXRlLnNlbmRMb2dCYXRjaFwiLFxuXHRcdFx0XHRkYXRhOiB7XG5cdFx0XHRcdFx0YWN0aW9uVHlwZTogXCJzZW5kTG9nQmF0Y2hcIixcblx0XHRcdFx0XHRhY3Rpb25BcmdzOiBhcmdzXG5cdFx0XHRcdH1cblx0XHRcdH0gKTtcblx0XHR9LFxuXHRcdHNlbmRNZXRyaWNzQmF0Y2goKSB7XG5cdFx0XHR2YXIgYXJncyA9IEFycmF5LmZyb20oIGFyZ3VtZW50cyApO1xuXHRcdFx0Y29uZmlndXJhdGlvbi5hY3Rpb25DaGFubmVsLnB1Ymxpc2goIHtcblx0XHRcdFx0dG9waWM6IFwiZXhlY3V0ZS5zZW5kTWV0cmljc0JhdGNoXCIsXG5cdFx0XHRcdGRhdGE6IHtcblx0XHRcdFx0XHRhY3Rpb25UeXBlOiBcInNlbmRNZXRyaWNzQmF0Y2hcIixcblx0XHRcdFx0XHRhY3Rpb25BcmdzOiBhcmdzXG5cdFx0XHRcdH1cblx0XHRcdH0gKTtcblx0XHR9XG5cdH0gKTtcblxuXHRcblxudmFyIGxvZ0xldmVscyA9IFsgXCJlcnJvclwiLCBcIndhcm5cIiwgXCJpbmZvXCIsIFwiZGVidWdcIiBdO1xuXG5mdW5jdGlvbiBmb3JtYXRMb2dFbnRyeSggdHlwZSwgZGF0YSApIHtcblx0dmFyIG1zZyA9IGRhdGE7XG5cblx0aWYgKCB3aW5kb3cgJiYgd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5uYXZpZ2F0b3IgKSB7XG5cdFx0bXNnID0ge1xuXHRcdFx0ZGF0YTogZGF0YSxcblx0XHRcdGxvY2F0aW9uOiB3aW5kb3cubG9jYXRpb24uaHJlZixcblx0XHRcdHVzZXJBZ2VudDogd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnRcblx0XHR9O1xuXHR9XG5cblx0cmV0dXJuIHtcblx0XHRtc2c6IG1zZyxcblx0XHR0aW1lc3RhbXA6IG1vbWVudC51dGMoKS50b0lTT1N0cmluZygpLFxuXHRcdHR5cGU6IHR5cGUsXG5cdFx0bGV2ZWw6IGxvZ0xldmVscy5pbmRleE9mKCB0eXBlICkgKyAxXG5cdH07XG59XG5cbmZ1bmN0aW9uIGxvZ0l0KCB0eXBlLCBkYXRhICkge1xuXHRsdXgucHVibGlzaEFjdGlvbiggXCJzZW5kTG9nRW50cnlcIiwgZm9ybWF0TG9nRW50cnkoIHR5cGUsIGRhdGEgKSApO1xufVxuXG52YXIgbG9nZ2luZ0FwaSA9IF8ucmVkdWNlKFxuXHRsb2dMZXZlbHMsXG5cdCggYWNjLCBsZXZlbCApID0+IHtcblx0XHRhY2NbIGxldmVsIF0gPSBmdW5jdGlvbiggZGF0YSApIHtcblx0XHRcdHJldHVybiBsb2dJdCggbGV2ZWwsIGRhdGEgKTtcblx0XHR9O1xuXHRcdHJldHVybiBhY2M7XG5cdH0sXG5cdHt9XG4pO1xuXG5sdXguY3VzdG9tQWN0aW9uQ3JlYXRvciggbG9nZ2luZ0FwaSApO1xuXG5sdXguYWRkVG9BY3Rpb25Hcm91cCggXCJsb2dnaW5nXCIsIGxvZ0xldmVscyApO1xuXG5cdFxuXG5cbi8vIE5lZWQgdG8gZmlndXJlIG91dCBhYm91dCBjdXN0b20gbWV0YWRhdGFcbmZ1bmN0aW9uIGZvcm1hdE1ldHJpY3NFbnRyeSggdHlwZSwga2V5LCB2YWx1ZSwgdW5pdCwgZGF0YSApIHtcblx0cmV0dXJuIHtcblx0XHR0eXBlOiB0eXBlLCAvLyBcInRpbWVcIiB8IFwibWV0ZXJcIiB8IFtjdXN0b20gdmFsdWVdXG5cdFx0a2V5OiBrZXksIC8vIHlvdXIgbWV0cmljIGtleVxuXHRcdHRpbWVzdGFtcDogbW9tZW50LnV0YygpLnRvSVNPU3RyaW5nKCksXG5cdFx0dmFsdWU6IHZhbHVlLFxuXHRcdHVuaXRzOiB1bml0XG5cdH07XG59XG5cbnZhciBtZXRyaWNzQXBpID0ge1xuXHRtZXRlcjogZnVuY3Rpb24oIGtleSwgdmFsdWUsIHVuaXQsIGN1c3RvbURhdGEgKSB7XG5cdFx0bHV4LnB1Ymxpc2hBY3Rpb24oIFwic2VuZE1ldHJpY3NFbnRyeVwiLCBmb3JtYXRNZXRyaWNzRW50cnkoIFwibWV0ZXJcIiwga2V5LCB2YWx1ZSwgdW5pdCwgY3VzdG9tRGF0YSApICk7XG5cdH0sXG5cdHRpbWVyOiBmdW5jdGlvbigga2V5LCB2YWx1ZSwgY3VzdG9tRGF0YSApIHtcblx0XHRsdXgucHVibGlzaEFjdGlvbiggXCJzZW5kTWV0cmljc0VudHJ5XCIsIGZvcm1hdE1ldHJpY3NFbnRyeSggXCJ0aW1lclwiLCBrZXksIHZhbHVlLCBcIm1zXCIsIGN1c3RvbURhdGEgKSApO1xuXHR9XG59O1xuXG5sdXguY3VzdG9tQWN0aW9uQ3JlYXRvciggbWV0cmljc0FwaSApO1xuXG5sdXguYWRkVG9BY3Rpb25Hcm91cCggXCJtZXRyaWNzXCIsIFsgXCJtZXRlclwiLCBcInRpbWVyXCIgXSApO1xuXG5cdFxuXG5cbnZhciBtZXRyaWNzQ2xpZW50ID0ge1xuXHRhY3Rpb246IFwic2VuZE1ldHJpY3NCYXRjaFwiLFxuXHRxdWV1ZTogW10sXG5cdGNvbmZpZzogY29uZmlndXJhdGlvbi5tZXRyaWNzXG59O1xudmFyIGxvZ2dpbmdDbGllbnQgPSB7XG5cdGFjdGlvbjogXCJzZW5kTG9nQmF0Y2hcIixcblx0cXVldWU6IFtdLFxuXHRjb25maWc6IGNvbmZpZ3VyYXRpb24ubG9nZ2luZ1xufTtcblxudmFyIGJhdGNoTWFuYWdlciA9IG5ldyBtYWNoaW5hLkJlaGF2aW9yYWxGc20oIHtcblx0aW5pdGlhbFN0YXRlOiBcInF1ZXVlaW5nXCIsXG5cdHN0YXRlczoge1xuXHRcdC8vIE1pZ2h0IG5lZWQgYW4gaW5pdGlhbGl6aW5nIHN0YXRlXG5cdFx0cXVldWVpbmc6IHtcblx0XHRcdF9vbkVudGVyKCBjbGllbnQgKSB7XG5cdFx0XHRcdGNsaWVudC50aW1lb3V0ID0gc2V0VGltZW91dCggKCkgPT4gdGhpcy5oYW5kbGUoIGNsaWVudCwgXCJ0cmFuc21pdFwiICksIGNsaWVudC5jb25maWcudGltZW91dCApO1xuXHRcdFx0fSxcblx0XHRcdHF1ZXVlRW50cnkoIGNsaWVudCwgZGF0YSApIHtcblx0XHRcdFx0Y2xpZW50LnF1ZXVlLnB1c2goIGRhdGEgKTtcblx0XHRcdFx0aWYgKCBjbGllbnQucXVldWUubGVuZ3RoID49IGNsaWVudC5jb25maWcubWVzc2FnZXMgKSB7XG5cdFx0XHRcdFx0dGhpcy50cmFuc2l0aW9uKCBjbGllbnQsIFwidHJhbnNtaXR0aW5nXCIgKTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdHRyYW5zbWl0OiBcInRyYW5zbWl0dGluZ1wiXG5cdFx0fSxcblx0XHR0cmFuc21pdHRpbmc6IHtcblx0XHRcdF9vbkVudGVyKCBjbGllbnQgKSB7XG5cdFx0XHRcdGNsZWFyVGltZW91dCggY2xpZW50LnRpbWVvdXQgKTtcblx0XHRcdFx0dGhpcy5oYW5kbGUoIGNsaWVudCwgXCJ0cmFuc21pdFwiICk7XG5cdFx0XHR9LFxuXHRcdFx0dHJhbnNtaXQoIGNsaWVudCApIHtcblx0XHRcdFx0aWYgKCBjbGllbnQucXVldWUubGVuZ3RoICkge1xuXHRcdFx0XHRcdHZhciBxdWV1ZSA9IGNsaWVudC5xdWV1ZTtcblx0XHRcdFx0XHRjbGllbnQucXVldWUgPSBbXTtcblx0XHRcdFx0XHRsdXgucHVibGlzaEFjdGlvbiggY2xpZW50LmFjdGlvbiwgcXVldWUgKTtcblx0XHRcdFx0fVxuXHRcdFx0XHR0aGlzLnRyYW5zaXRpb24oIGNsaWVudCwgXCJxdWV1ZWluZ1wiICk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59ICk7XG5cbnZhciBiYXRjaExpc3RlbmVyID0gbHV4LmFjdGlvbkxpc3RlbmVyKCB7XG5cdGhhbmRsZXJzOiB7XG5cdFx0c2VuZExvZ0VudHJ5KCBkYXRhICkge1xuXHRcdFx0YmF0Y2hNYW5hZ2VyLmhhbmRsZSggbG9nZ2luZ0NsaWVudCwgXCJxdWV1ZUVudHJ5XCIsIGRhdGEgKTtcblx0XHR9LFxuXHRcdHNlbmRNZXRyaWNzRW50cnkoIGRhdGEgKSB7XG5cdFx0XHRiYXRjaE1hbmFnZXIuaGFuZGxlKCBtZXRyaWNzQ2xpZW50LCBcInF1ZXVlRW50cnlcIiwgZGF0YSApO1xuXHRcdH1cblx0fVxufSApO1xuXG5cdFxuXG5cbnZhciBpZ25vcmVkQWN0aW9ucyA9IFsgXCJzZW5kTG9nRW50cnlcIiwgXCJzZW5kTWV0cmljc0VudHJ5XCIsIFwic2VuZExvZ0JhdGNoXCIsIFwic2VuZE1ldHJpY3NCYXRjaFwiIF07XG5cbmZ1bmN0aW9uIGlzTW9uaXRvcmVkKCBhY3Rpb24gKSB7XG5cdHJldHVybiBpZ25vcmVkQWN0aW9ucy5pbmRleE9mKCBhY3Rpb24gKSA9PT0gLTEgJiZcblx0XHQoXG5cdFx0XHQoICFjb25maWd1cmF0aW9uLmZpbHRlci5pbmNsdWRlICYmIGNvbmZpZ3VyYXRpb24uZmlsdGVyLmFjdGlvbnMuaW5kZXhPZiggYWN0aW9uICkgPT09IC0xICkgfHxcblx0XHRcdCggY29uZmlndXJhdGlvbi5maWx0ZXIuaW5jbHVkZSAmJiBjb25maWd1cmF0aW9uLmZpbHRlci5hY3Rpb25zLmluZGV4T2YoIGFjdGlvbiApID4gLTEgKVxuXHRcdCk7XG59XG5cbmZ1bmN0aW9uIGdldENvbnRleHRLZXkoKSB7XG5cdHZhciBhcmdzID0gQXJyYXkuZnJvbSggYXJndW1lbnRzICk7XG5cdHZhciBob3N0O1xuXHR2YXIgcGF0aDtcblx0aWYgKCBsdXguZ2V0Q29udGV4dEtleSApIHtcblx0XHRyZXR1cm4gbHV4LmdldENvbnRleHRLZXkoIC4uLmFyZ3VtZW50cyApO1xuXHR9IGVsc2Uge1xuXHRcdGhvc3QgPSB3aW5kb3cubG9jYXRpb24uaG9zdC5yZXBsYWNlKCAvXFwuL2dpLCBcIi1cIiApO1xuXHRcdHBhdGggPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSggL1xcLy9pZywgXCItXCIgKTtcblx0XHRwYXRoID0gcGF0aFsgMCBdID09PSBcIi1cIiA/IHBhdGguc2xpY2UoIDEgKSA6IHBhdGg7XG5cdFx0cmV0dXJuICggWyBob3N0LCBwYXRoIF0uY29uY2F0KCBhcmdzICkgKS5qb2luKCBcIi5cIiApO1xuXHR9XG59XG5cbnZhciBhY3Rpb25Qcm9jZXNzb3IgPSBuZXcgbWFjaGluYS5Gc20oIHtcblx0aW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7XG5cdFx0bHV4LmRpc3BhdGNoZXIub24oIFwiaGFuZGxpbmdcIiwgKCBkYXRhICkgPT4ge1xuXHRcdFx0aWYgKCBkYXRhLmlucHV0VHlwZSA9PT0gXCJhY3Rpb24uZGlzcGF0Y2hcIiApIHtcblx0XHRcdFx0dGhpcy5oYW5kbGUoIFwic3RhcnRcIiwgZGF0YS5jbGllbnQuYWN0aW9uLmFjdGlvblR5cGUgKTtcblx0XHRcdH1cblx0XHR9ICk7XG5cdFx0bHV4LmRpc3BhdGNoZXIub24oIFwidHJhbnNpdGlvblwiLCAoIGRhdGEgKSA9PiB7XG5cdFx0XHRpZiAoIGRhdGEudG9TdGF0ZSA9PT0gXCJyZWFkeVwiICkge1xuXHRcdFx0XHR0aGlzLmhhbmRsZSggXCJkaXNwYXRjaGVyLmNvbXBsZXRlXCIgKTtcblx0XHRcdH1cblx0XHR9ICk7XG5cdH0sXG5cdGluaXRpYWxTdGF0ZTogXCJyZWFkeVwiLFxuXHRzdGF0ZXM6IHtcblx0XHRyZWFkeToge1xuXHRcdFx0X29uRW50ZXIoKSB7XG5cdFx0XHRcdHRoaXMuY3VycmVudCA9IHt9O1xuXHRcdFx0fSxcblx0XHRcdHN0YXJ0KCBhY3Rpb24gKSB7XG5cdFx0XHRcdGlmICggaXNNb25pdG9yZWQoIGFjdGlvbiApICkge1xuXHRcdFx0XHRcdHRoaXMuY3VycmVudCA9IHtcblx0XHRcdFx0XHRcdG5hbWU6IGFjdGlvbixcblx0XHRcdFx0XHRcdHN0YXJ0OiBtb21lbnQudXRjKCksXG5cdFx0XHRcdFx0XHRrZXk6IGdldENvbnRleHRLZXkoIGFjdGlvbiApXG5cdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRzZXRUaW1lb3V0KCAoKSA9PiB0aGlzLmhhbmRsZSggXCJhY3Rpb24uY29tcGxldGVcIiApLCAwICk7XG5cdFx0XHRcdFx0dGhpcy50cmFuc2l0aW9uKCBcInByb2Nlc3NpbmdcIiApO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSxcblx0XHRwcm9jZXNzaW5nOiB7XG5cdFx0XHRfb25FbnRlcigpIHtcblx0XHRcdFx0Ly8gKCBrZXksIHZhbHVlLCB1bml0LCBjdXN0b21EYXRhIClcblx0XHRcdFx0bWV0cmljc0FwaS5tZXRlciggdGhpcy5jdXJyZW50LmtleSwgMSwgXCJjb3VudFwiLCB7fSApO1xuXHRcdFx0fSxcblx0XHRcdFwiYWN0aW9uLmNvbXBsZXRlXCI6IFwicmVhZHlcIixcblx0XHRcdFwiKlwiOiBmdW5jdGlvbigpIHtcblx0XHRcdFx0dGhpcy5kZWZlclVudGlsVHJhbnNpdGlvbigpO1xuXHRcdFx0fSxcblx0XHRcdF9vbkV4aXQoKSB7XG5cdFx0XHRcdC8vICgga2V5LCB2YWx1ZSwgY3VzdG9tRGF0YSApXG5cdFx0XHRcdG1ldHJpY3NBcGkudGltZXIoIHRoaXMuY3VycmVudC5rZXksIG1vbWVudC51dGMoKS5kaWZmKCB0aGlzLmN1cnJlbnQuc3RhcnQgKSwge30gKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cbn0gKTtcblxuXG5cdC8vIGpzaGludCBpZ25vcmU6IHN0YXJ0XG5cdHJldHVybiB7XG5cdFx0Y29uZmlnLFxuXHRcdGFjdGlvblByb2Nlc3Nvcixcblx0XHRiYXRjaE1hbmFnZXIsXG5cdFx0YmF0Y2hMaXN0ZW5lcixcblx0XHRtZXRyaWNzQ2xpZW50LFxuXHRcdGxvZ2dpbmdDbGllbnRcblx0fTtcblx0Ly8ganNoaW50IGlnbm9yZTogZW5kXG59ICkgKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
