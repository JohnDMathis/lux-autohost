/**
 * lux-autohost - Action Creator API for submitting logging & metrics to autohost from lux.js apps.
 * Author: Jim Cowart
 * Version: v0.0.2
 * Url: https://github.com/LeanKit-Labs/lux-autohost
 * License(s): MIT Copyright (c) 2015 LeanKit
 */

( function( root, factory ) {
	/* istanbul ignore next - don't test UMD wrapper */
	if ( typeof define === "function" && define.amd ) {
		// AMD. Register as an anonymous module.
		define( [ "lux.js", "postal", "machina", "lodash", "moment" ], factory );
	} else if ( typeof module === "object" && module.exports ) {
		// Node, or CommonJS-Like environments
		module.exports = factory( require( "lux.js" ), require( "postal" ), require( "machina" ), require( "lodash" ), require( "moment" ) );
	} else {
		root.luxah = factory( root.lux, root.postal, root.machina, root._, root.moment );
	}
} )( this, function( lux, postal, machina, _, moment ) {
	var configuration = {
		actionChannel: postal.channel( "lux.action" ),
		filter: {
			include: false,
			actions: []
		},
		metrics: {
			timeout: 30000,
			messages: 500
		},
		logging: {
			timeout: 5000,
			messages: 25
		}
	};

	function config( options ) {
		if ( options ) {
			_.merge( configuration, options );
		}
		return configuration;
	}

	lux.customActionCreator( {
		sendLogBatch: function sendLogBatch() {
			var args = Array.from( arguments );
			configuration.actionChannel.publish( {
				topic: "execute.sendLogBatch",
				data: {
					actionType: "sendLogBatch",
					actionArgs: args
				}
			} );
		},
		sendMetricsBatch: function sendMetricsBatch() {
			var args = Array.from( arguments );
			configuration.actionChannel.publish( {
				topic: "execute.sendMetricsBatch",
				data: {
					actionType: "sendMetricsBatch",
					actionArgs: args
				}
			} );
		}
	} );

	var logLevels = [ "error", "warn", "info", "debug" ];

	function formatLogEntry( type, data ) {
		var msg = data;

		if ( window && window.location && window.navigator ) {
			msg = {
				data: data,
				location: window.location.href,
				userAgent: window.navigator.userAgent
			};
		}

		return {
			msg: msg,
			timestamp: moment.utc().toISOString(),
			type: type,
			level: logLevels.indexOf( type ) + 1
		};
	}

	function logIt( type, data ) {
		lux.publishAction( "sendLogEntry", formatLogEntry( type, data ) );
	}

	var loggingApi = _.reduce( logLevels, function( acc, level ) {
		acc[level] = function( data ) {
			return logIt( level, data );
		};
		return acc;
	}, {} );

	lux.customActionCreator( loggingApi );

	lux.addToActionGroup( "logging", logLevels );

	// Need to figure out about custom metadata
	function formatMetricsEntry( type, key, value, unit, data ) {
		return {
			type: type, // "time" | "meter" | [custom value]
			key: key, // your metric key
			timestamp: moment.utc().toISOString(),
			value: value,
			units: unit
		};
	}

	var metricsApi = {
		meter: function meter( key, value, unit, customData ) {
			lux.publishAction( "sendMetricsEntry", formatMetricsEntry( "meter", key, value, unit, customData ) );
		},
		timer: function timer( key, value, customData ) {
			lux.publishAction( "sendMetricsEntry", formatMetricsEntry( "timer", key, value, "ms", customData ) );
		}
	};

	lux.customActionCreator( metricsApi );

	lux.addToActionGroup( "metrics", [ "meter", "timer" ] );

	var metricsClient = {
		action: "sendMetricsBatch",
		queue: [],
		config: configuration.metrics
	};
	var loggingClient = {
		action: "sendLogBatch",
		queue: [],
		config: configuration.logging
	};

	var batchManager = new machina.BehavioralFsm( {
		initialState: "queueing",
		states: {
			// Might need an initializing state
			queueing: {
				_onEnter: function _onEnter( client ) {
					var _this = this;

					client.timeout = setTimeout( function() {
						return _this.handle( client, "transmit" );
					}, client.config.timeout );
				},
				queueEntry: function queueEntry( client, data ) {
					client.queue.push( data );
					if ( client.queue.length >= client.config.messages ) {
						this.transition( client, "transmitting" );
					}
				},
				transmit: "transmitting"
			},
			transmitting: {
				_onEnter: function _onEnter( client ) {
					clearTimeout( client.timeout );
					this.handle( client, "transmit" );
				},
				transmit: function transmit( client ) {
					if ( client.queue.length ) {
						var queue = client.queue;
						client.queue = [];
						lux.publishAction( client.action, queue );
					}
					this.transition( client, "queueing" );
				}
			}
		}
	} );

	var batchListener = lux.actionListener( {
		handlers: {
			sendLogEntry: function sendLogEntry( data ) {
				batchManager.handle( loggingClient, "queueEntry", data );
			},
			sendMetricsEntry: function sendMetricsEntry( data ) {
				batchManager.handle( metricsClient, "queueEntry", data );
			}
		}
	} );

	var ignoredActions = [ "sendLogEntry", "sendMetricsEntry", "sendLogBatch", "sendMetricsBatch" ];

	function isMonitored( action ) {
		return ignoredActions.indexOf( action ) === -1 && ( !configuration.filter.include && configuration.filter.actions.indexOf( action ) === -1 || configuration.filter.include && configuration.filter.actions.indexOf( action ) > -1 );
	}

	function getContextKey() {
		var args = Array.from( arguments );
		var host;
		var path;
		if ( lux.getContextKey ) {
			return lux.getContextKey.apply( lux, arguments );
		} else {
			host = window.location.host.replace( /\./gi, "-" );
			path = window.location.pathname.replace( /\//ig, "-" );
			path = path[0] === "-" ? path.slice( 1 ) : path;
			return [ host, path ].concat( args ).join( "." );
		}
	}

	var actionProcessor = new machina.Fsm( {
		initialize: function initialize() {
			var _this2 = this;

			lux.dispatcher.on( "handling", function( data ) {
				if ( data.inputType === "action.dispatch" ) {
					_this2.handle( "start", data.client.action.actionType );
				}
			} );
			lux.dispatcher.on( "transition", function( data ) {
				if ( data.toState === "ready" ) {
					_this2.handle( "dispatcher.complete" );
				}
			} );
		},
		initialState: "ready",
		states: {
			ready: {
				_onEnter: function _onEnter() {
					this.current = {};
				},
				start: function start( action ) {
					var _this3 = this;

					if ( isMonitored( action ) ) {
						this.current = {
							name: action,
							start: moment.utc(),
							key: getContextKey( action )
						};
						setTimeout( function() {
							return _this3.handle( "action.complete" );
						}, 0 );
						this.transition( "processing" );
					}
				}
			},
			processing: {
				_onEnter: function _onEnter() {
					// ( key, value, unit, customData )
					metricsApi.meter( this.current.key, 1, "count", {} );
				},
				"action.complete": "ready",
				"*": function _() {
					this.deferUntilTransition();
				},
				_onExit: function _onExit() {
					// ( key, value, customData )
					metricsApi.timer( this.current.key, moment.utc().diff( this.current.start ), {} );
				}
			}
		}
	} );

	// jshint ignore: start
	return {
		config: config,
		actionProcessor: actionProcessor,
		batchManager: batchManager,
		batchListener: batchListener,
		metricsClient: metricsClient,
		loggingClient: loggingClient
	};
	// jshint ignore: end
} );
//# sourceMappingURL=data:application/json;base64,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KCByb290LCBmYWN0b3J5ICkge1xuXHQvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAtIGRvbid0IHRlc3QgVU1EIHdyYXBwZXIgKi9cblx0aWYgKCB0eXBlb2YgZGVmaW5lID09PSBcImZ1bmN0aW9uXCIgJiYgZGVmaW5lLmFtZCApIHtcblx0XHQvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuXG5cdFx0ZGVmaW5lKCBbIFwibHV4LmpzXCIsIFwicG9zdGFsXCIsIFwibWFjaGluYVwiLCBcImxvZGFzaFwiLCBcIm1vbWVudFwiIF0sIGZhY3RvcnkgKTtcblx0fSBlbHNlIGlmICggdHlwZW9mIG1vZHVsZSA9PT0gXCJvYmplY3RcIiAmJiBtb2R1bGUuZXhwb3J0cyApIHtcblx0XHQvLyBOb2RlLCBvciBDb21tb25KUy1MaWtlIGVudmlyb25tZW50c1xuXHRcdG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSggcmVxdWlyZSggXCJsdXguanNcIiApLCByZXF1aXJlKCBcInBvc3RhbFwiICksIHJlcXVpcmUoIFwibWFjaGluYVwiICksIHJlcXVpcmUoIFwibG9kYXNoXCIgKSwgcmVxdWlyZSggXCJtb21lbnRcIiApICk7XG5cdH0gZWxzZSB7XG5cdFx0cm9vdC5sdXhhaCA9IGZhY3RvcnkoIHJvb3QubHV4LCByb290LnBvc3RhbCwgcm9vdC5tYWNoaW5hLCByb290Ll8sIHJvb3QubW9tZW50ICk7XG5cdH1cbn0oIHRoaXMsIGZ1bmN0aW9uKCBsdXgsIHBvc3RhbCwgbWFjaGluYSwgXywgbW9tZW50ICkge1xuXHR2YXIgY29uZmlndXJhdGlvbiA9IHtcblx0XHRhY3Rpb25DaGFubmVsOiBwb3N0YWwuY2hhbm5lbCggXCJsdXguYWN0aW9uXCIgKSxcblx0XHRmaWx0ZXI6IHtcblx0XHRcdGluY2x1ZGU6IGZhbHNlLFxuXHRcdFx0YWN0aW9uczogW11cblx0XHR9LFxuXHRcdG1ldHJpY3M6IHtcblx0XHRcdHRpbWVvdXQ6IDMwMDAwLFxuXHRcdFx0bWVzc2FnZXM6IDUwMFxuXHRcdH0sXG5cdFx0bG9nZ2luZzoge1xuXHRcdFx0dGltZW91dDogNTAwMCxcblx0XHRcdG1lc3NhZ2VzOiAyNVxuXHRcdH1cblx0fTtcblxuXHRmdW5jdGlvbiBjb25maWcoIG9wdGlvbnMgKSB7XG5cdFx0aWYgKCBvcHRpb25zICkge1xuXHRcdFx0Xy5tZXJnZSggY29uZmlndXJhdGlvbiwgb3B0aW9ucyApO1xuXHRcdH1cblx0XHRyZXR1cm4gY29uZmlndXJhdGlvbjtcblx0fVxuXG5cdGx1eC5jdXN0b21BY3Rpb25DcmVhdG9yKCB7XG5cdFx0c2VuZExvZ0JhdGNoKCkge1xuXHRcdFx0dmFyIGFyZ3MgPSBBcnJheS5mcm9tKCBhcmd1bWVudHMgKTtcblx0XHRcdGNvbmZpZ3VyYXRpb24uYWN0aW9uQ2hhbm5lbC5wdWJsaXNoKCB7XG5cdFx0XHRcdHRvcGljOiBcImV4ZWN1dGUuc2VuZExvZ0JhdGNoXCIsXG5cdFx0XHRcdGRhdGE6IHtcblx0XHRcdFx0XHRhY3Rpb25UeXBlOiBcInNlbmRMb2dCYXRjaFwiLFxuXHRcdFx0XHRcdGFjdGlvbkFyZ3M6IGFyZ3Ncblx0XHRcdFx0fVxuXHRcdFx0fSApO1xuXHRcdH0sXG5cdFx0c2VuZE1ldHJpY3NCYXRjaCgpIHtcblx0XHRcdHZhciBhcmdzID0gQXJyYXkuZnJvbSggYXJndW1lbnRzICk7XG5cdFx0XHRjb25maWd1cmF0aW9uLmFjdGlvbkNoYW5uZWwucHVibGlzaCgge1xuXHRcdFx0XHR0b3BpYzogXCJleGVjdXRlLnNlbmRNZXRyaWNzQmF0Y2hcIixcblx0XHRcdFx0ZGF0YToge1xuXHRcdFx0XHRcdGFjdGlvblR5cGU6IFwic2VuZE1ldHJpY3NCYXRjaFwiLFxuXHRcdFx0XHRcdGFjdGlvbkFyZ3M6IGFyZ3Ncblx0XHRcdFx0fVxuXHRcdFx0fSApO1xuXHRcdH1cblx0fSApO1xuXG5cdFxuXG52YXIgbG9nTGV2ZWxzID0gWyBcImVycm9yXCIsIFwid2FyblwiLCBcImluZm9cIiwgXCJkZWJ1Z1wiIF07XG5cbmZ1bmN0aW9uIGZvcm1hdExvZ0VudHJ5KCB0eXBlLCBkYXRhICkge1xuXHR2YXIgbXNnID0gZGF0YTtcblxuXHRpZiAoIHdpbmRvdyAmJiB3aW5kb3cubG9jYXRpb24gJiYgd2luZG93Lm5hdmlnYXRvciApIHtcblx0XHRtc2cgPSB7XG5cdFx0XHRkYXRhOiBkYXRhLFxuXHRcdFx0bG9jYXRpb246IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuXHRcdFx0dXNlckFnZW50OiB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudFxuXHRcdH07XG5cdH1cblxuXHRyZXR1cm4ge1xuXHRcdG1zZzogbXNnLFxuXHRcdHRpbWVzdGFtcDogbW9tZW50LnV0YygpLnRvSVNPU3RyaW5nKCksXG5cdFx0dHlwZTogdHlwZSxcblx0XHRsZXZlbDogbG9nTGV2ZWxzLmluZGV4T2YoIHR5cGUgKSArIDFcblx0fTtcbn1cblxuZnVuY3Rpb24gbG9nSXQoIHR5cGUsIGRhdGEgKSB7XG5cdGx1eC5wdWJsaXNoQWN0aW9uKCBcInNlbmRMb2dFbnRyeVwiLCBmb3JtYXRMb2dFbnRyeSggdHlwZSwgZGF0YSApICk7XG59XG5cbnZhciBsb2dnaW5nQXBpID0gXy5yZWR1Y2UoXG5cdGxvZ0xldmVscyxcblx0KCBhY2MsIGxldmVsICkgPT4ge1xuXHRcdGFjY1sgbGV2ZWwgXSA9IGZ1bmN0aW9uKCBkYXRhICkge1xuXHRcdFx0cmV0dXJuIGxvZ0l0KCBsZXZlbCwgZGF0YSApO1xuXHRcdH07XG5cdFx0cmV0dXJuIGFjYztcblx0fSxcblx0e31cbik7XG5cbmx1eC5jdXN0b21BY3Rpb25DcmVhdG9yKCBsb2dnaW5nQXBpICk7XG5cbmx1eC5hZGRUb0FjdGlvbkdyb3VwKCBcImxvZ2dpbmdcIiwgbG9nTGV2ZWxzICk7XG5cblx0XG5cblxuLy8gTmVlZCB0byBmaWd1cmUgb3V0IGFib3V0IGN1c3RvbSBtZXRhZGF0YVxuZnVuY3Rpb24gZm9ybWF0TWV0cmljc0VudHJ5KCB0eXBlLCBrZXksIHZhbHVlLCB1bml0LCBkYXRhICkge1xuXHRyZXR1cm4ge1xuXHRcdHR5cGU6IHR5cGUsIC8vIFwidGltZVwiIHwgXCJtZXRlclwiIHwgW2N1c3RvbSB2YWx1ZV1cblx0XHRrZXk6IGtleSwgLy8geW91ciBtZXRyaWMga2V5XG5cdFx0dGltZXN0YW1wOiBtb21lbnQudXRjKCkudG9JU09TdHJpbmcoKSxcblx0XHR2YWx1ZTogdmFsdWUsXG5cdFx0dW5pdHM6IHVuaXRcblx0fTtcbn1cblxudmFyIG1ldHJpY3NBcGkgPSB7XG5cdG1ldGVyOiBmdW5jdGlvbigga2V5LCB2YWx1ZSwgdW5pdCwgY3VzdG9tRGF0YSApIHtcblx0XHRsdXgucHVibGlzaEFjdGlvbiggXCJzZW5kTWV0cmljc0VudHJ5XCIsIGZvcm1hdE1ldHJpY3NFbnRyeSggXCJtZXRlclwiLCBrZXksIHZhbHVlLCB1bml0LCBjdXN0b21EYXRhICkgKTtcblx0fSxcblx0dGltZXI6IGZ1bmN0aW9uKCBrZXksIHZhbHVlLCBjdXN0b21EYXRhICkge1xuXHRcdGx1eC5wdWJsaXNoQWN0aW9uKCBcInNlbmRNZXRyaWNzRW50cnlcIiwgZm9ybWF0TWV0cmljc0VudHJ5KCBcInRpbWVyXCIsIGtleSwgdmFsdWUsIFwibXNcIiwgY3VzdG9tRGF0YSApICk7XG5cdH1cbn07XG5cbmx1eC5jdXN0b21BY3Rpb25DcmVhdG9yKCBtZXRyaWNzQXBpICk7XG5cbmx1eC5hZGRUb0FjdGlvbkdyb3VwKCBcIm1ldHJpY3NcIiwgWyBcIm1ldGVyXCIsIFwidGltZXJcIiBdICk7XG5cblx0XG5cblxudmFyIG1ldHJpY3NDbGllbnQgPSB7XG5cdGFjdGlvbjogXCJzZW5kTWV0cmljc0JhdGNoXCIsXG5cdHF1ZXVlOiBbXSxcblx0Y29uZmlnOiBjb25maWd1cmF0aW9uLm1ldHJpY3Ncbn07XG52YXIgbG9nZ2luZ0NsaWVudCA9IHtcblx0YWN0aW9uOiBcInNlbmRMb2dCYXRjaFwiLFxuXHRxdWV1ZTogW10sXG5cdGNvbmZpZzogY29uZmlndXJhdGlvbi5sb2dnaW5nXG59O1xuXG52YXIgYmF0Y2hNYW5hZ2VyID0gbmV3IG1hY2hpbmEuQmVoYXZpb3JhbEZzbSgge1xuXHRpbml0aWFsU3RhdGU6IFwicXVldWVpbmdcIixcblx0c3RhdGVzOiB7XG5cdFx0Ly8gTWlnaHQgbmVlZCBhbiBpbml0aWFsaXppbmcgc3RhdGVcblx0XHRxdWV1ZWluZzoge1xuXHRcdFx0X29uRW50ZXIoIGNsaWVudCApIHtcblx0XHRcdFx0Y2xpZW50LnRpbWVvdXQgPSBzZXRUaW1lb3V0KCAoKSA9PiB0aGlzLmhhbmRsZSggY2xpZW50LCBcInRyYW5zbWl0XCIgKSwgY2xpZW50LmNvbmZpZy50aW1lb3V0ICk7XG5cdFx0XHR9LFxuXHRcdFx0cXVldWVFbnRyeSggY2xpZW50LCBkYXRhICkge1xuXHRcdFx0XHRjbGllbnQucXVldWUucHVzaCggZGF0YSApO1xuXHRcdFx0XHRpZiAoIGNsaWVudC5xdWV1ZS5sZW5ndGggPj0gY2xpZW50LmNvbmZpZy5tZXNzYWdlcyApIHtcblx0XHRcdFx0XHR0aGlzLnRyYW5zaXRpb24oIGNsaWVudCwgXCJ0cmFuc21pdHRpbmdcIiApO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0dHJhbnNtaXQ6IFwidHJhbnNtaXR0aW5nXCJcblx0XHR9LFxuXHRcdHRyYW5zbWl0dGluZzoge1xuXHRcdFx0X29uRW50ZXIoIGNsaWVudCApIHtcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KCBjbGllbnQudGltZW91dCApO1xuXHRcdFx0XHR0aGlzLmhhbmRsZSggY2xpZW50LCBcInRyYW5zbWl0XCIgKTtcblx0XHRcdH0sXG5cdFx0XHR0cmFuc21pdCggY2xpZW50ICkge1xuXHRcdFx0XHRpZiAoIGNsaWVudC5xdWV1ZS5sZW5ndGggKSB7XG5cdFx0XHRcdFx0dmFyIHF1ZXVlID0gY2xpZW50LnF1ZXVlO1xuXHRcdFx0XHRcdGNsaWVudC5xdWV1ZSA9IFtdO1xuXHRcdFx0XHRcdGx1eC5wdWJsaXNoQWN0aW9uKCBjbGllbnQuYWN0aW9uLCBxdWV1ZSApO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHRoaXMudHJhbnNpdGlvbiggY2xpZW50LCBcInF1ZXVlaW5nXCIgKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cbn0gKTtcblxudmFyIGJhdGNoTGlzdGVuZXIgPSBsdXguYWN0aW9uTGlzdGVuZXIoIHtcblx0aGFuZGxlcnM6IHtcblx0XHRzZW5kTG9nRW50cnkoIGRhdGEgKSB7XG5cdFx0XHRiYXRjaE1hbmFnZXIuaGFuZGxlKCBsb2dnaW5nQ2xpZW50LCBcInF1ZXVlRW50cnlcIiwgZGF0YSApO1xuXHRcdH0sXG5cdFx0c2VuZE1ldHJpY3NFbnRyeSggZGF0YSApIHtcblx0XHRcdGJhdGNoTWFuYWdlci5oYW5kbGUoIG1ldHJpY3NDbGllbnQsIFwicXVldWVFbnRyeVwiLCBkYXRhICk7XG5cdFx0fVxuXHR9XG59ICk7XG5cblx0XG5cblxudmFyIGlnbm9yZWRBY3Rpb25zID0gWyBcInNlbmRMb2dFbnRyeVwiLCBcInNlbmRNZXRyaWNzRW50cnlcIiwgXCJzZW5kTG9nQmF0Y2hcIiwgXCJzZW5kTWV0cmljc0JhdGNoXCIgXTtcblxuZnVuY3Rpb24gaXNNb25pdG9yZWQoIGFjdGlvbiApIHtcblx0cmV0dXJuIGlnbm9yZWRBY3Rpb25zLmluZGV4T2YoIGFjdGlvbiApID09PSAtMSAmJlxuXHRcdChcblx0XHRcdCggIWNvbmZpZ3VyYXRpb24uZmlsdGVyLmluY2x1ZGUgJiYgY29uZmlndXJhdGlvbi5maWx0ZXIuYWN0aW9ucy5pbmRleE9mKCBhY3Rpb24gKSA9PT0gLTEgKSB8fFxuXHRcdFx0KCBjb25maWd1cmF0aW9uLmZpbHRlci5pbmNsdWRlICYmIGNvbmZpZ3VyYXRpb24uZmlsdGVyLmFjdGlvbnMuaW5kZXhPZiggYWN0aW9uICkgPiAtMSApXG5cdFx0KTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29udGV4dEtleSgpIHtcblx0dmFyIGFyZ3MgPSBBcnJheS5mcm9tKCBhcmd1bWVudHMgKTtcblx0dmFyIGhvc3Q7XG5cdHZhciBwYXRoO1xuXHRpZiAoIGx1eC5nZXRDb250ZXh0S2V5ICkge1xuXHRcdHJldHVybiBsdXguZ2V0Q29udGV4dEtleSggLi4uYXJndW1lbnRzICk7XG5cdH0gZWxzZSB7XG5cdFx0aG9zdCA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0LnJlcGxhY2UoIC9cXC4vZ2ksIFwiLVwiICk7XG5cdFx0cGF0aCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKCAvXFwvL2lnLCBcIi1cIiApO1xuXHRcdHBhdGggPSBwYXRoWyAwIF0gPT09IFwiLVwiID8gcGF0aC5zbGljZSggMSApIDogcGF0aDtcblx0XHRyZXR1cm4gKCBbIGhvc3QsIHBhdGggXS5jb25jYXQoIGFyZ3MgKSApLmpvaW4oIFwiLlwiICk7XG5cdH1cbn1cblxudmFyIGFjdGlvblByb2Nlc3NvciA9IG5ldyBtYWNoaW5hLkZzbSgge1xuXHRpbml0aWFsaXplOiBmdW5jdGlvbigpIHtcblx0XHRsdXguZGlzcGF0Y2hlci5vbiggXCJoYW5kbGluZ1wiLCAoIGRhdGEgKSA9PiB7XG5cdFx0XHRpZiAoIGRhdGEuaW5wdXRUeXBlID09PSBcImFjdGlvbi5kaXNwYXRjaFwiICkge1xuXHRcdFx0XHR0aGlzLmhhbmRsZSggXCJzdGFydFwiLCBkYXRhLmNsaWVudC5hY3Rpb24uYWN0aW9uVHlwZSApO1xuXHRcdFx0fVxuXHRcdH0gKTtcblx0XHRsdXguZGlzcGF0Y2hlci5vbiggXCJ0cmFuc2l0aW9uXCIsICggZGF0YSApID0+IHtcblx0XHRcdGlmICggZGF0YS50b1N0YXRlID09PSBcInJlYWR5XCIgKSB7XG5cdFx0XHRcdHRoaXMuaGFuZGxlKCBcImRpc3BhdGNoZXIuY29tcGxldGVcIiApO1xuXHRcdFx0fVxuXHRcdH0gKTtcblx0fSxcblx0aW5pdGlhbFN0YXRlOiBcInJlYWR5XCIsXG5cdHN0YXRlczoge1xuXHRcdHJlYWR5OiB7XG5cdFx0XHRfb25FbnRlcigpIHtcblx0XHRcdFx0dGhpcy5jdXJyZW50ID0ge307XG5cdFx0XHR9LFxuXHRcdFx0c3RhcnQoIGFjdGlvbiApIHtcblx0XHRcdFx0aWYgKCBpc01vbml0b3JlZCggYWN0aW9uICkgKSB7XG5cdFx0XHRcdFx0dGhpcy5jdXJyZW50ID0ge1xuXHRcdFx0XHRcdFx0bmFtZTogYWN0aW9uLFxuXHRcdFx0XHRcdFx0c3RhcnQ6IG1vbWVudC51dGMoKSxcblx0XHRcdFx0XHRcdGtleTogZ2V0Q29udGV4dEtleSggYWN0aW9uIClcblx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdHNldFRpbWVvdXQoICgpID0+IHRoaXMuaGFuZGxlKCBcImFjdGlvbi5jb21wbGV0ZVwiICksIDAgKTtcblx0XHRcdFx0XHR0aGlzLnRyYW5zaXRpb24oIFwicHJvY2Vzc2luZ1wiICk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LFxuXHRcdHByb2Nlc3Npbmc6IHtcblx0XHRcdF9vbkVudGVyKCkge1xuXHRcdFx0XHQvLyAoIGtleSwgdmFsdWUsIHVuaXQsIGN1c3RvbURhdGEgKVxuXHRcdFx0XHRtZXRyaWNzQXBpLm1ldGVyKCB0aGlzLmN1cnJlbnQua2V5LCAxLCBcImNvdW50XCIsIHt9ICk7XG5cdFx0XHR9LFxuXHRcdFx0XCJhY3Rpb24uY29tcGxldGVcIjogXCJyZWFkeVwiLFxuXHRcdFx0XCIqXCI6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHR0aGlzLmRlZmVyVW50aWxUcmFuc2l0aW9uKCk7XG5cdFx0XHR9LFxuXHRcdFx0X29uRXhpdCgpIHtcblx0XHRcdFx0Ly8gKCBrZXksIHZhbHVlLCBjdXN0b21EYXRhIClcblx0XHRcdFx0bWV0cmljc0FwaS50aW1lciggdGhpcy5jdXJyZW50LmtleSwgbW9tZW50LnV0YygpLmRpZmYoIHRoaXMuY3VycmVudC5zdGFydCApLCB7fSApO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxufSApO1xuXG5cblx0Ly8ganNoaW50IGlnbm9yZTogc3RhcnRcblx0cmV0dXJuIHtcblx0XHRjb25maWcsXG5cdFx0YWN0aW9uUHJvY2Vzc29yLFxuXHRcdGJhdGNoTWFuYWdlcixcblx0XHRiYXRjaExpc3RlbmVyLFxuXHRcdG1ldHJpY3NDbGllbnQsXG5cdFx0bG9nZ2luZ0NsaWVudFxuXHR9O1xuXHQvLyBqc2hpbnQgaWdub3JlOiBlbmRcbn0gKSApO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
